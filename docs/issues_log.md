# 問題点・隘路事項ログ

本ドキュメントは、開発中に発生した問題点・隘路事項・指摘事項を記録する。
今後も問題や指摘があった場合はこのドキュメントに追記すること。

---

## 記録フォーマット

```
### #<番号> <タイトル>
- **発生日**: YYYY-MM-DD
- **スプリント**: Sprint X
- **カテゴリ**: ブランチ運用 / コード品質 / 環境構築 / 設計 / その他
- **内容**: 何が起きたか
- **原因**: なぜ起きたか
- **対応**: どう対応したか
- **再発防止**: 今後どうするか
```

---

## 問題一覧

### #1 Sprint 1の実装が規約外のブランチで行われた
- **発生日**: 2026-02-10
- **スプリント**: Sprint 1
- **カテゴリ**: ブランチ運用
- **内容**: `git_workflow_guide.md` では「1スプリント = 1ブランチ」「命名規則は `claude/sprint-<番号>`」と定めているにもかかわらず、Sprint 1の実装が `claude/review-sprint-zero-El87p` という別名ブランチ上で行われた。
- **原因**: Claude Code起動時にシステムから自動割り当てされたブランチ名をそのまま使用し、プロジェクト固有のブランチ命名規約を確認・適用しなかった。
- **対応**: `main` ブランチから正しい `claude/sprint-1` ブランチを新規作成し、該当コミットを `cherry-pick` で移行した。
- **再発防止**:
  - Sprint開始時に必ず `git_workflow_guide.md` のブランチ命名規則を確認する
  - ブランチ名は `claude/sprint-<番号>` 形式を厳守する
  - 緊急バグ修正のみ `claude/bugfix-<問題名>` を使用する

### #2 Sprint 0の環境構築が不完全なまま完了報告されていた
- **発生日**: 2026-02-10
- **スプリント**: Sprint 0
- **カテゴリ**: 環境構築
- **内容**: `sprint_0_completion.md` では「達成度: 100%」と報告されていたが、実際の環境を検証したところ以下が未完了だった:
  - `.streamlit/config.toml` が未作成
  - `assets/` ディレクトリ（styles.css, sounds/）が未作成
  - `.env.example` が未作成
  - `README.md` が空
  - ドキュメント内のライブラリバージョン記載が実際の `requirements.txt` と不一致
- **原因**: Sprint 0の完了報告が設計ドキュメントの作成のみに着目し、実際のファイル・ディレクトリ構成の検証を行わなかった。
- **対応**: 不足ファイルをすべて作成し、ドキュメントのバージョン記載を `requirements.txt` の実値（supabase==2.3.4）に合わせて修正した。
- **再発防止**:
  - スプリント完了時に、完了報告書のチェックリストを実環境上で1項目ずつ検証する
  - 「ドキュメント上の完了」と「環境上の完了」を区別して確認する

### #3 gotrue と httpx のバージョン非互換による起動エラー
- **発生日**: 2026-02-10
- **スプリント**: Sprint 1
- **カテゴリ**: 環境構築
- **内容**: `streamlit run Home.py` 実行時に `TypeError: Client.__init__() got an unexpected keyword argument 'proxy'` が発生。`supabase==2.3.4` は `gotrue>=1.3,<3.0` と広い範囲を許容しており、pip が新しい gotrue をインストール。しかし `supabase==2.3.4` 自体は `httpx>=0.24,<0.26` を要求するため、gotrue が使う `httpx.Client(proxy=...)` がエラーとなった。
- **原因**: `supabase==2.3.4` の依存仕様で `gotrue<3.0` と広すぎる範囲を許容していた。PyPI 調査の結果、gotrue のバージョンごとの httpx 要件は以下の通り:
  - `gotrue<=2.8.1`: `httpx>=0.24,<0.28` → supabase 2.3.4 と **互換**
  - `gotrue>=2.9.0`: `httpx>=0.26,<0.28` → supabase 2.3.4 の `httpx<0.26` と **非互換**
  - `gotrue>=2.10.0`: `httpx>=0.26,<0.28`（同上）
- **対応（最終）**: `requirements.txt` に `gotrue>=2.4.1,<2.9.0` を明示し、httpx 0.24-0.25 と互換性のある gotrue バージョンに制約した。httpx は supabase の依存関係で自動解決される。
  - ※ 初回対応で `httpx>=0.28.0` をピン留めしたが、supabase 2.3.4 が `httpx<0.26` を要求しており `ResolutionImpossible` エラーとなった。根本原因は gotrue 側であり、httpx ではなかった。
- **再発防止**:
  - 間接依存でもバージョン範囲の広いパッケージは PyPI の依存仕様を直接確認する
  - 修正時は依存ツリー全体の制約を確認し、一箇所のピン留めが他の制約と矛盾しないか検証する
  - `pip install` 後に `pip check` で依存関係の整合性を確認する

### #4 サインアップ時に user_profiles の RLS ポリシー違反
- **発生日**: 2026-02-11
- **スプリント**: Sprint 1
- **カテゴリ**: 設計
- **内容**: 新規ユーザー登録時に `new row violates row-level security policy for table "user_profiles"` (42501) エラーが発生。
- **原因**: `signup()` で `sign_up()` → `user_profiles` INSERT の順で実行していたが、`sign_up()` 後にセッションが未確立（メール確認待ち等）の場合、`auth.uid()` が NULL となり RLS の `auth.uid() = id` を満たせなかった。アプリ側からの INSERT は認証状態に依存するため不安定。
- **対応**: Supabase 推奨パターン「DB トリガーによる自動プロフィール作成」に変更。
  - `auth.users` への INSERT をトリガーで検知し、`SECURITY DEFINER` 関数で `user_profiles` に自動挿入
  - `sign_up()` に `options.data.display_name` としてメタデータを渡し、トリガーが `raw_user_meta_data` から取得
  - アプリ側の手動 INSERT を削除
- **再発防止**:
  - Supabase Auth 連携のテーブルは DB トリガーで作成し、アプリ側からの直接 INSERT に依存しない
  - RLS ポリシー設計時に、認証フロー中のセッション状態を考慮する

---

## 今後の運用

- 問題や指摘が発生した場合、本ドキュメントに新しいエントリを `### #<連番>` 形式で追記する
- 各スプリントの振り返り時に本ドキュメントをレビューし、再発防止策が守られているか確認する
- カテゴリ別に傾向を分析し、繰り返される問題には仕組みでの対策を検討する
